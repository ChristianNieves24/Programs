#!/usr/bin/python
import h5py
import sys
from glob import glob
from numpy import genfromtxt, sum, array,sqrt,zeros
from pylab import show, scatter, colorbar, xlabel, ylabel, title, imshow,plot, subplot, axvspan,xlim,ylim,axes

# Interval of bins (a,b)
a = 180
b = 230


def plot_bin(bns):
    subplot(211)
    for bn in bns:
        imshow(bn, origin='0', aspect="auto", interpolation="bilinear")
    axvspan(0,a, alpha=0.25, facecolor="black")
    axvspan(b,len(bn[1])-1, alpha=0.25, facecolor="black")


def plot_angular_response(az, el, cps):
    subplot(223)
    scatter(az, el, c=cps)
    # title("SXM Angular Response (bins " + str(a) + " to " + str(b) + ")")
    xlabel("Azimuth (deg)")
    ylabel("Elevation (deg)")
    xlim(-40,40)
    ylim(-40,40)
    colorbar().set_label("Counts/sec")


def plot_events_rms(events):
    subplot(224)

    eventsByTime = []
    temp = []

    # Sort data from shortest time to longest
    for i in events:
        temp.append(i[1])
    while len(temp) != 0:
        for j in events:
            if j[1] == min(temp):
                eventsByTime.append(j)
                temp.remove(min(temp))
                break

    # Total RMS
    s = zeros(len(events[0][0]),float)
    for i in range(len(events)):
        # Sum squares
        s += (events[i][0])**2

    m = s / len(events)
    rms = sqrt(m)
    plot(range(a,b), rms,"--o")
    plot(range(a,b), eventsByTime[0][0],"--o")
    plot(range(a,b), eventsByTime[len(eventsByTime)-1][0],"--o")



# Get directories from user
h5FilesDir = str(sys.argv[1])
logfilesTablePath = str(sys.argv[2])

tableData = genfromtxt(logfilesTablePath, str)

# Gets all the .h5 files from the specified directory
if h5FilesDir.endswith("/"):
    filePaths = glob(h5FilesDir + "*.h5")
else:
    h5FilesDir += "/"
    filePaths = glob(h5FilesDir + "*.h5")

countsPerSec = []
elevation = []
azimuth = []
binList = []
eventsTimeList = []

for i in filePaths:
    fileName = i[len(h5FilesDir):(len(i) - len(".h5"))]

    # Find files in the directory that match with the files on the table
    for m in tableData:
        if m[2] == fileName:  # m[2] is the logfile name on table

            # Calculate counts per second
            dataFile = h5py.File(i)
            binList.append(dataFile['data/tlm_sxm_data/hdr']['bin'])
            bins = dataFile['data/tlm_sxm_data/hdr']['bin'][:, a:b]

            s = sum(bins, 1)
            totalTime = float(32 * len(s) / 2 + 18 * len(s) / 2)
            cps = sum(bins) / totalTime

            print(bins.shape)

            azimuth.append(float(m[0]))
            elevation.append(float(m[1]))
            countsPerSec.append(cps)
            eventsTimeList.append([sum(bins,0), totalTime])

plot_bin(binList)
plot_angular_response(azimuth, elevation, countsPerSec)
plot_events_rms(eventsTimeList)
show()
